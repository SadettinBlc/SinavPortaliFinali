@model SinavPortaliFinal.Models.Exam

@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container mt-4" style="max-width: 800px;">

    <div class="card shadow-sm border-0 mb-4 border-start border-5 border-primary">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h3 class="fw-bold text-dark mb-1">@Model.Title</h3>
                    <span class="badge bg-primary">@(Model.Category?.Name ?? "Genel")</span>
                </div>

                <div class="text-end">
                    <div class="small text-muted fw-bold mb-1">KALAN SÜRE</div>
                    <div id="timer" class="badge bg-danger fs-5 shadow-sm">00:00</div>
                </div>
            </div>

            <hr class="my-3 opacity-25">

            <div class="alert alert-info small mb-0">
                <i class="fa fa-info-circle me-2"></i>
                Süre bitiminde sınavınız <strong>otomatik olarak</strong> gönderilecektir.
            </div>
        </div>
    </div>

    <form action="/Student/FinishExam" method="post" id="examForm">

        <input type="hidden" name="examId" value="@Model.Id" />

        @if (Model.Questions != null && Model.Questions.Count > 0)
        {
            int i = 0;
            foreach (var q in Model.Questions)
            {
                i++;
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom-0 pt-3">
                        <h5 class="fw-bold text-dark">
                            <span class="badge bg-secondary me-2">@i</span>
                        </h5>
                        <p class="lead mb-0 mt-2" style="font-size: 1.1rem;">@q.QuestionText</p>
                    </div>
                    <div class="card-body pt-0">
                        <hr class="text-muted opacity-25">

                        <div class="list-group">
                            <label class="list-group-item list-group-item-action d-flex align-items-center cursor-pointer">
                                <input class="form-check-input me-3" type="radio" name="answers[@q.Id]" value="A" required>
                                <span class="fw-bold me-2">A)</span> @q.OptionA
                            </label>

                            <label class="list-group-item list-group-item-action d-flex align-items-center cursor-pointer">
                                <input class="form-check-input me-3" type="radio" name="answers[@q.Id]" value="B" required>
                                <span class="fw-bold me-2">B)</span> @q.OptionB
                            </label>

                            <label class="list-group-item list-group-item-action d-flex align-items-center cursor-pointer">
                                <input class="form-check-input me-3" type="radio" name="answers[@q.Id]" value="C" required>
                                <span class="fw-bold me-2">C)</span> @q.OptionC
                            </label>

                            <label class="list-group-item list-group-item-action d-flex align-items-center cursor-pointer">
                                <input class="form-check-input me-3" type="radio" name="answers[@q.Id]" value="D" required>
                                <span class="fw-bold me-2">D)</span> @q.OptionD
                            </label>
                        </div>
                    </div>
                </div>
            }

            <div class="d-grid gap-2 mb-5">
                <button type="submit" class="btn btn-success btn-lg fw-bold shadow">
                    <i class="fa fa-check-circle me-2"></i> Sınavı Tamamla
                </button>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center">
                <h4>Bu sınava soru eklenmemiş!</h4>
                <a href="/Student/Index" class="btn btn-secondary mt-2">Geri Dön</a>
            </div>
        }

    </form>
</div>

<script>
    // Modelden gelen süreyi al (Dakika cinsinden)
    var durationMinutes = @Model.Duration;

    // Saniyeye çevir
    var timeInSeconds = durationMinutes * 60;

    var timerElement = document.getElementById('timer');

    // Her saniye çalışacak kod
    var timerInterval = setInterval(function() {
        var minutes = Math.floor(timeInSeconds / 60);
        var seconds = timeInSeconds % 60;

        // Ekrana 05:09 gibi yazdır
        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        timerElement.innerHTML = minutes + ":" + seconds;

        // Son 1 dakika kalınca rengi sarı yap, dikkat çeksin
        if(timeInSeconds < 60) {
            timerElement.classList.remove('bg-danger');
            timerElement.classList.add('bg-warning', 'text-dark');
        }

        // Süre bitti mi?
        if (timeInSeconds <= 0) {
            clearInterval(timerInterval);
            timerElement.innerHTML = "00:00";

            // SweetAlert ile uyarı ver ve formu gönder
            Swal.fire({
                title: 'Süre Doldu!',
                text: 'Süreniz bitti, cevaplarınız otomatik gönderiliyor...',
                icon: 'warning',
                timer: 3000,
                showConfirmButton: false,
                willClose: () => {
                    document.getElementById('examForm').submit();
                }
            });
        }

        timeInSeconds--; // Süreyi azalt
    }, 1000);
</script>

<style>
    .list-group-item:hover {
        background-color: #f8f9fa;
    }

    .form-check-input:checked + span + span,
    .list-group-item:has(.form-check-input:checked) {
        background-color: #e8f5e9;
        border-color: #a5d6a7;
        color: #1b5e20;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>